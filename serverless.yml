service: waiterix-backend
useDotenv: true
build:
  esbuild:
    bundle: true
    minify: false
    sourcemap: true
    exclude:
      - aws-sdk
    external:
      - '@google-cloud/firestore'
      - 'firebase-admin'
      - 'pg-native'
    target: "node20"
frameworkVersion: '4'

provider:
  name: aws
  runtime: nodejs20.x
  stage: ${opt:stage, 'dev'}
  region: ${opt:region, 'us-east-1'}
  memorySize: 1024
  timeout: 29

  # üîí VPC Configuration ‚Äì REQUIRED for RDS + Redis access
  vpc:
    securityGroupIds:
      - sg-0c37f6030af724718  # waiterix-lambda-sg
    subnetIds:
      - subnet-08269a5290ccbd69b  # us-east-1b (private)
      - subnet-0fc4b474540afd23f  # us-east-1a (private)

  environment:
    NODE_ENV: ${self:provider.stage}

    # üóÑÔ∏è Database
    DATABASE_URL: postgresql://waiterix_user:Mypassword407%21@waiterix.cejyqycwo39y.us-east-1.rds.amazonaws.com:5432/waiterix
    DB_HOST: waiterix.cejyqycwo39y.us-east-1.rds.amazonaws.com
    DB_PORT: '5432'
    DB_NAME: waiterix
    DB_USER: waiterix_user
    DB_PASSWORD: Mypassword407!
    DB_SSL: 'true'

    # üß† Redis
    REDIS_HOST: master.waiterix-redis.ufx4zx.use1.cache.amazonaws.com
    REDIS_PORT: '6379'
    REDIS_PASSWORD: AllahummasallialaMuhammad1!
    REDIS_DB: '0'

    # ‚òÅÔ∏è AWS Services
    AWS_S3_BUCKET: waiterix-storage
    AWS_S3_TRANSCRIBE_BUCKET: waiterix-transcribe-temp
    AWS_S3_REGION: us-east-1

    # üìß SES
    SES_FROM_EMAIL: noreply@nomagro.com
    SUPPORT_EMAIL: support@nomagro.com

    # üì° DynamoDB
    WEBSOCKET_CONNECTIONS_TABLE: waiterix-websocket-connections

    # üí≥ Stripe
    STRIPE_SECRET_KEY: sk_test_51SXnfY2VZXX1nihiLJ78hL5DVPaOqoXhU2TwGCldGBJzrAgGNJ6lTxYsNW6bE1bMFJ7KIBH9Gdz7NJdOUyCYz2AE00Ux84umtM
    STRIPE_WEBHOOK_SECRET: sk_test_51SXnfY2VZXX1nihiLJ78hL5DVPaOqoXhU2TwGCldGBJzrAgGNJ6lTxYsNW6bE1bMFJ7KIBH9Gdz7NJdOUyCYz2AE00Ux84umtM
    STRIPE_BASE_PRICE_ID: price_1SXnmn2VZXX1nihitL4P9y02
    STRIPE_USAGE_PRICE_ID: price_1SXnkJ2VZXX1nihiNA7puV2l
    STRIPE_METER_EVENT_NAME: price_1SXnkJ2VZXX1nihiNA7puV2l

    # üí≥ Paystack
    PAYSTACK_SECRET_KEY: sk_test_ec72a27e12b915928c86230be7702153bb5a779b
    PAYSTACK_PUBLIC_KEY: pk_test_b0b9c6670701f7d9b6ea379bd447292a34d6f1d0

    # üîê Firebase
    FIREBASE_PROJECT_ID: waiterix-65cc6
    FIREBASE_PRIVATE_KEY: AIzaSyA_AgNCd2jC65G4W8420ZJEDVh8jHPCSA8
    FIREBASE_CLIENT_EMAIL: umarkabir@harmoniallc.com

    # üåê App
    FRONTEND_URL: 'https://main.dtrmx4cj0i1ha.amplifyapp.com'
    API_BASE_URL: ''
    VITE_API_BASE_URL: 'https://lo8m97qrtl.execute-api.us-east-1.amazonaws.com/dev'
  iam:
    role:
      statements:
        # üìù CloudWatch Logs
        - Effect: Allow
          Action:
            - logs:CreateLogGroup
            - logs:CreateLogStream
            - logs:PutLogEvents
          Resource: 'arn:aws:logs:*:*:*'

        # ü§ñ AWS Bedrock (AI)
        - Effect: Allow
          Action:
            - bedrock:InvokeModel
            - bedrock:InvokeModelWithResponseStream
          Resource:
            - 'arn:aws:bedrock:*::foundation-model/anthropic.claude-3-5-sonnet-20241022-v2:0'
            - 'arn:aws:bedrock:*::foundation-model/anthropic.claude-3-haiku-20240307-v1:0'

        # üîä AWS Polly (TTS)
        - Effect: Allow
          Action:
            - polly:SynthesizeSpeech
          Resource: '*'

        # üé§ AWS Transcribe (STT)
        - Effect: Allow
          Action:
            - transcribe:StartTranscriptionJob
            - transcribe:GetTranscriptionJob
          Resource: '*'

        # üì¶ S3 Buckets
        - Effect: Allow
          Action:
            - s3:GetObject
            - s3:PutObject
            - s3:DeleteObject
          Resource:
            - 'arn:aws:s3:::waiterix-storage'
            - 'arn:aws:s3:::waiterix-storage/*'
            - 'arn:aws:s3:::waiterix-transcribe-temp'
            - 'arn:aws:s3:::waiterix-transcribe-temp/*'

        # üìß SES Email
        - Effect: Allow
          Action:
            - ses:SendEmail
            - ses:SendRawEmail
          Resource: '*'

        # üì° DynamoDB (WebSocket connections)
        - Effect: Allow
          Action:
            - dynamodb:PutItem
            - dynamodb:GetItem
            - dynamodb:DeleteItem
            - dynamodb:UpdateItem
          Resource:
            - 'arn:aws:dynamodb:${self:provider.region}:*:table/waiterix-websocket-connections'

        # üîå API Gateway (WebSocket management)
        - Effect: Allow
          Action:
            - execute-api:ManageConnections
          Resource:
            - 'arn:aws:execute-api:${self:provider.region}:*:*/*/@connections/*'

functions:
  api:
    handler: src/handlers/api.handler
    events:
      - http:
          path: /{proxy+}
          method: ANY
          cors:
            origin: 'https://main.dtrmx4cj0i1ha.amplifyapp.com'
            headers:
              - Content-Type
              - X-Amz-Date
              - Authorization
              - X-Api-Key
              - X-Amz-Security-Token
              - X-Amz-User-Agent
              - x-paystack-signature
              - stripe-signature
            exposedHeaders:
              - Set-Cookie
            allowCredentials: true
      - http:
          path: /
          method: ANY
          cors:
            origin: 'https://main.dtrmx4cj0i1ha.amplifyapp.com'
            headers:
              - Content-Type
              - X-Amz-Date
              - Authorization
              - X-Api-Key
              - X-Amz-Security-Token
              - X-Amz-User-Agent
              - x-paystack-signature
              - stripe-signature
            exposedHeaders:
              - Set-Cookie
            allowCredentials: true

  # üåê WebSocket Handlers
  websocketConnect:
    handler: src/apiGatewayWebSocket.handleConnect
    events:
      - websocket:
          route: $connect

  websocketDisconnect:
    handler: src/apiGatewayWebSocket.handleDisconnect
    events:
      - websocket:
          route: $disconnect

  websocketMessage:
    handler: src/apiGatewayWebSocket.handleMessage
    events:
      - websocket:
          route: $default

# ‚öôÔ∏è Plugins (only offline if needed)
plugins:
  - serverless-offline

# üõ†Ô∏è Custom Settings
custom:
  serverless-offline:
    httpPort: 3001
    websocketPort: 3002
    host: 0.0.0.0