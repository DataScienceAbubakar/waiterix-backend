service: waiterix-backend
useDotenv: true

build:
  esbuild:
    bundle: true
    minify: false
    sourcemap: true
    exclude:
      - aws-sdk
    external:
      - '@google-cloud/firestore'
      - 'firebase-admin'
      - 'pg-native'
    target: "node20"

frameworkVersion: '4'

provider:
  name: aws
  runtime: nodejs20.x
  stage: ${opt:stage, 'dev'}
  region: ${opt:region, 'us-east-1'}
  memorySize: 1024
  timeout: 29

  # üîí VPC Configuration
  vpc:
    securityGroupIds:
      - sg-0c37f6030af724718
    subnetIds:
      - subnet-08269a5290ccbd69b
      - subnet-0fc4b474540afd23f

  environment:
    NODE_ENV: ${self:provider.stage}

    # üóÑÔ∏è Database
    DATABASE_URL: postgresql://waiterix_user:Mypassword407%21@waiterix.cejyqycwo39y.us-east-1.rds.amazonaws.com:5432/waiterix
    DB_HOST: waiterix.cejyqycwo39y.us-east-1.rds.amazonaws.com
    DB_PORT: '5432'
    DB_NAME: waiterix
    DB_USER: waiterix_user
    DB_PASSWORD: Mypassword407!
    DB_SSL: 'true'

    # üß† Redis
    REDIS_HOST: master.waiterix-redis.ufx4zx.use1.cache.amazonaws.com
    REDIS_PORT: '6379'
    REDIS_PASSWORD: AllahummasallialaMuhammad1!
    REDIS_DB: '0'

    # ‚òÅÔ∏è AWS Services
    AWS_S3_BUCKET: waiterix-storage
    AWS_S3_TRANSCRIBE_BUCKET: waiterix-transcribe-temp
    AWS_S3_REGION: us-east-1

    # üìß SES
    SES_FROM_EMAIL: noreply@nomagro.com
    SUPPORT_EMAIL: support@nomagro.com

    # üì° DynamoDB
    WEBSOCKET_CONNECTIONS_TABLE: waiterix-websocket-connections

    # üí≥ Stripe
    STRIPE_SECRET_KEY: sk_test_51SXnfY2VZXX1nihiLJ78hL5DVPaOqoXhU2TwGCldGBJzrAgGNJ6lTxYsNW6bE1bMFJ7KIBH9Gdz7NJdOUyCYz2AE00Ux84umtM
    STRIPE_WEBHOOK_SECRET: sk_test_51SXnfY2VZXX1nihiLJ78hL5DVPaOqoXhU2TwGCldGBJzrAgGNJ6lTxYsNW6bE1bMFJ7KIBH9Gdz7NJdOUyCYz2AE00Ux84umtM
    STRIPE_BASE_PRICE_ID: price_1SXnmn2VZXX1nihitL4P9y02
    STRIPE_USAGE_PRICE_ID: price_1SXnkJ2VZXX1nihiNA7puV2l
    STRIPE_METER_EVENT_NAME: price_1SXnkJ2VZXX1nihiNA7puV2l

    # üí≥ Paystack
    PAYSTACK_SECRET_KEY: sk_test_ec72a27e12b915928c86230be7702153bb5a779b
    PAYSTACK_PUBLIC_KEY: pk_test_b0b9c6670701f7d9b6ea379bd447292a34d6f1d0

    # üîê Firebase
    FIREBASE_PROJECT_ID: waiterix-bff96
    FIREBASE_CLIENT_EMAIL: firebase-adminsdk-fbsvc@waiterix-bff96.iam.gserviceaccount.com
    FIREBASE_PRIVATE_KEY: '-----BEGIN PRIVATE KEY-----\nMIIEvAIBADANBgkqhkiG9w0BAQEFAASCBKYwggSiAgEAAoIBAQCKs0Qwfb0e2XzR\nljN4Lx+HrPXZTEWyZHZbWFsFfc3Psqb+WsU4Q8Mv3iZuv6S6oqf8ObJsShkbBb9S\ned6mndr8gw4g0kTd7qvvMXZZIUqJInCPhFl268iB8Z80QJrWwHBxWD0DcLIg3Svi\neQU7UWcfxjQBYJt/kWmWlIoAGKBVfvRnV98pl+c1/1MKEVDnKUWtxMwrgM0F3mTo\nMOPIUBIJ/04T7g6qxX4YU9dOXWNpatW8LD1bMvIlhhE3YU65Q4FfTMeI7MBLIFkd\ndvyGMWIjCoefQuOj2jIyfIsPTkK61+UHakaP3jEO3n9X4yv9YiSwaBy9ECSgLH6u\nxHxxGA7rAgMBAAECggEAKao2Vra+5BCDPVZ4eab2OsSLSc5utWsWXtRI63piI/1P\nyuKrkf5RGQUL2IL7UhFgkxUl8v/DUOnGElmHt9d9nBMmYFep1l1HCuB548ZrZIyS\n8ZnZYi7sGZTitUie+tnuLS5LjcgBynuGHk8qcio+5z2cC7ngnE6rQE+4sNS0/Vln\ngHkdV3bH2L3qGUv1bf8ZVt+NurUmNV+8z/zPUuI/ARc1v+tWTbp6tVRtmPpsnK83\nC3Zr2LTSyFmzxe8zKsLuaeCs6JVXOfydsjofQNiAl0XyHineUg9EI/HtNcka7BvE\nYLjGxDHpIguKWXHIiHFmIQx2bF9tSWiGjNmwgVaXKQKBgQDCPY9Fqc+EVVKIuHfb\nRVyimx/dwDez0ggHXadf7LQqtWQBP8g9jQ20/fMZY8YjHhHKYbkXXmySvpC72HJV\n6hmpHg4sMfYIkt5/MJ6IfojeZk9gvxL/yqkZuh9F6wCgnwxINpd0liiU8kcdzF0T\nhYp1dheXO2mQM34x/T9alOKO3wKBgQC2zPGM0C6M/TvYDDZFtvZSZkIYy0rAQHA/\nFyzLyMJvOcpmoD/mJFOWfvH6nIfO7ajqV3PzWZ/MQ+hXZB9Kp18XgaMCd5YXUTgx\nnB9DmvO/SH+uhuERymzYFkqBBtVNd0rEe6lb03G9gVjDl3WU1/3G/gxxKHmARXBP\n+nrG39KddQKBgFYtIadyk1LO1/M4hFSQDW1HDXhAk3YANPevoVZ5meVo3JmBRsGo\nFvC5ymT1Uy65ZIM5n/iyN9FTIrt0aCWd2wyg/QC2mcVsA7LCS1Obb/XbxlPR8gfy\nTdvQK5fFj12zsqtHLSLYi+CpLMwXoyPKF4fNgOHjxg3oCpD7HmR9sZZZAoGAB8M2\nMrOYdnY+d1M1bspxNViQT/s6BmX2Hke+qDyzPQPoO2lsrTo3rnlfjzPcdIYVGTZz\nfw78QTFVCXj/9yyaViY0JOOtJPpW94xYq4dF+IZ8nY2uuxGsg5SWv1np7us06pkR\nvQuClfiLK2sgHBz78tpQ7vE4D6FjPpI1aoKQsA0CgYAsyQqigYiL4R83P/YuNLtC\nid8pP8auuUAtS9mEcRYJMfZeA1cZ3iXAzqfRqQ55QHJwc+NII6ILlBr58mJjhRJl\nLRKp4BMUdlVeIDWJfF6RtZzsCuNDztDxYZPDaTbdgOX13MbpveHD4a4sdtyk+loL\nP2crB+qaG/aT6Pvz3xQvHQ==\n-----END PRIVATE KEY-----\n'

    # üåê URLs
    FRONTEND_URL: 'https://main.d182r8qb7g7hdy.amplifyapp.com'
    API_BASE_URL: ''

  iam:
    role:
      statements:
        - Effect: Allow
          Action:
            - logs:CreateLogGroup
            - logs:CreateLogStream
            - logs:PutLogEvents
          Resource: 'arn:aws:logs:*:*:*'

        - Effect: Allow
          Action:
            - bedrock:InvokeModel
            - bedrock:InvokeModelWithResponseStream
          Resource:
            - 'arn:aws:bedrock:*::foundation-model/anthropic.claude-3-5-sonnet-20241022-v2:0'
            - 'arn:aws:bedrock:*::foundation-model/anthropic.claude-3-haiku-20240307-v1:0'

        - Effect: Allow
          Action:
            - polly:SynthesizeSpeech
          Resource: '*'

        - Effect: Allow
          Action:
            - transcribe:StartTranscriptionJob
            - transcribe:GetTranscriptionJob
          Resource: '*'

        - Effect: Allow
          Action:
            - s3:GetObject
            - s3:PutObject
            - s3:DeleteObject
          Resource:
            - 'arn:aws:s3:::waiterix-storage'
            - 'arn:aws:s3:::waiterix-storage/*'
            - 'arn:aws:s3:::waiterix-transcribe-temp'
            - 'arn:aws:s3:::waiterix-transcribe-temp/*'

        - Effect: Allow
          Action:
            - ses:SendEmail
            - ses:SendRawEmail
          Resource: '*'

        - Effect: Allow
          Action:
            - dynamodb:PutItem
            - dynamodb:GetItem
            - dynamodb:DeleteItem
            - dynamodb:UpdateItem
          Resource:
            - 'arn:aws:dynamodb:${self:provider.region}:*:table/waiterix-websocket-connections'

        - Effect: Allow
          Action:
            - execute-api:ManageConnections
          Resource:
            - 'arn:aws:execute-api:${self:provider.region}:*:*/*/@connections/*'

functions:
  api:
    handler: src/handlers/api.handler
    events:
      - http:
          path: /{proxy+}
          method: ANY
          cors:
            origin: 'https://main.d182r8qb7g7hdy.amplifyapp.com'
            headers:
              - Content-Type
              - X-Amz-Date
              - Authorization
              - X-Api-Key
              - X-Amz-Security-Token
              - X-Amz-User-Agent
              - x-paystack-signature
              - stripe-signature
            allowCredentials: true
      - http:
          path: /
          method: ANY
          cors:
            origin: 'https://main.d182r8qb7g7hdy.amplifyapp.com'
            headers:
              - Content-Type
              - X-Amz-Date
              - Authorization
              - X-Api-Key
              - X-Amz-Security-Token
              - X-Amz-User-Agent
              - x-paystack-signature
              - stripe-signature
            allowCredentials: true

  websocketConnect:
    handler: src/apiGatewayWebSocket.handleConnect
    events:
      - websocket:
          route: $connect

  websocketDisconnect:
    handler: src/apiGatewayWebSocket.handleDisconnect
    events:
      - websocket:
          route: $disconnect

  websocketMessage:
    handler: src/apiGatewayWebSocket.handleMessage
    events:
      - websocket:
          route: $default

plugins:
  - serverless-offline

custom:
  serverless-offline:
    httpPort: 3005
    websocketPort: 3006
    host: 0.0.0.0

resources:
  Resources:
    WebsocketConnectionsTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: 
        AttributeDefinitions:
          - AttributeName: connectionId
            AttributeType: S
        KeySchema:
          - AttributeName: connectionId
            KeyType: HASH
        BillingMode: PAY_PER_REQUEST
